#include <stdio.h>
#include <string.h>
#include "socket.h"
#include <unistd.h>
#include <sys/types.h>
#include <sys/socket.h>
#include <sys/wait.h>
#include <stdlib.h>


int main()
{
   int  serv;
   int  socket_client;
   char message [1024] = "";

   //char *split1;
   //char *split2;
   char       *split3;
   char       *methode;
   char       *ressource;
   FILE       * f;
   char       tok [1024];
   const char *e400              = "HTTP/1.1 400 Bad Request\r\nConnection: Close\r\nContent-Length: 17 \r\n\n400 Bad request\r";
   const char *e200              = "HTTP/1.1 200 OK\r\nContent-Length: ";
   const char *message_bienvenue = "we shall put a long message here... Who you gonna call? TextBuster !\n\n__________________________________________▓▓▓\n_________________________________________▓▒▒▒▓▓\n____________________▄▄▄▄▄▄▄▄▄__________▓▒▒▒▒▒▓\n___▓▓▓▓▓____▄█████▓▓▓▓▓▓░░███████▓▒▒▒▒▓▒▓\n____▓▒▓▒▓▓▓██▓█▓▓▓▓▓▓▓░░░▓▓▓▓▓▓▓▓▒▒▒▒▒▓▒▓\n______▓▒▒▒▓▒▒▓▓▓▓▓▓▓▓░░░▓▓▓▓▓▓▓▓█▒▒▒▒▒▒▓▒▓\n______█▓▓▒▒▓▒▒▓▒▒▓▓▓░░░▓▓▓▓▓▓▓▓█▒▒▒▒▒▒▒▓▒▓\n____▄█▓▓█▓▓▓▒▒▒▓▒▓▓░░░░▓▓▓▓▓▓▓▓█▒▒▒▒▒▒▓▒▒▓\n___█▓▓▓█▓▓█▓▓▒▓▒▓▓▓░░░░▓▓▓▓▓▓▓▓▓█▒▒▒▒▓▒▒▒▓\n__█▓▓▓█▓▓█▓▓▓▓▓▓▓▓▓░░░█████████████▒▒▒▒▒▒▓\n__█▓▓▓█▓▓█▓▓▓▓▓▓██████▒▌__▓█_____▓▓▒▒▒▒▒▒▒▓\n_▐█▓▓█▓▓▓█▓▓████▒▒▒▒▒▒▌__▓▓█▄____▓▓▒▒▒▒▒▒▓\n_▐█▓█▓▓▓▓███▒▒▒▒▒▒▒▒▒▒▌__▓▓█████▓▓▒▒▒▒▒▒▓\n__█▓█▓▓██_▅▄██▄▒▒▒▒▒▒▒▐___▓▓█▄_██▓▓▄▅▅▒▒▒▓\n__█▓▓██__▅▄▄▄▌__▀▄▒▒▒▒▒▐___▓▓▓████▓▅▅▄▒▒▒█\n__█▓█_________▓▄___▀▒▒▒▒▒▐____▓▓▓▓▓▓▅▅▄▒▒▒██\n__██___________▓▓█▀█▄▒▒▒▒▒▌________▒▒▒▒▒▒█▓█▌\n_________________▓▓███▒▒▒▒▒▐____▒▒▒██▒▒██▓██▌\n___________________▓▓▓▒▒▒▒▒▒▒▒▒▒▒▒█▓▓██▓▓██▓▌\n____________________▓▒▒▄▒▒▌▒▒▒▒▒▒▒█▓▓▓▓██▓▓▓█\n___________________▓▒▒▒▒▒▐▒▒▒▒▒▒▒█▓███▓▓▓█▓▓█▌\n_____________________▓▓▓▄▀▒▒▒▒▓▓▓█▓▓▓▓▓▓█▓▓▓▓██\n_________________________▓▓▓▓▓▓____█▓▓██▀▀█▓▓▓▓░░█\n______________________________________▀▀__▄█▓▓▓▓▓░░▓█\n_______________________________________▄██▓▓▓▓▓▓░░▓▓█\n_____________________________________██▓▓▓▓▓▓▓▓░░▓▓█\n______________________________________█▓▓▓▓▓▓▓░░░▓▓█\n_______________________________________█▓▓▓▓▓░░░▓▓▓█\n________________________________________█▓▓▓░░░▓▓▓▓█\n__________________________________________██░░░▓▓▓▓█\n_____________________________________________█░▓▓▓█\n_______________________________________________████\n";

   serv = creer_serveur(4242);

   if (serv == -1)
   {
      perror("creer_serveur");
      return -1;
   }

   initialiser_signaux();

   while (1)
   {
      socket_client = accept(serv, NULL, NULL);
      if (socket_client == -1)
      {
         perror("accept error");
      }
      int pid = fork();

      if (pid == 0)
      {
         f = fdopen(socket_client, "w+");
         fgets(message, sizeof(message), f);
         //printf("<Webserver> %s", message);
         while (fgets(tok, sizeof(tok), f) != NULL && tok[0] != '\r' && tok[0] != '\n')
            ;
         methode = strtok(message, " ");
         strtok(NULL, " ");
         ressource = strtok(NULL, " ");
         split3    = strtok(NULL, " ");
         if ((strcmp(methode, "GET") == 0) && (ressource != NULL) && (split3 == NULL) && ((strstr(ressource, "HTTP/1.0") == 0) || (strstr(ressource, "HTTP/1.1") == 0)))
         {
            fprintf(f, "%s : %d \r\n\n %s\n", e200, (int)strlen(message_bienvenue), message_bienvenue);
            fflush(f);
            fclose(f);
         }
         else
         {
            fprintf(f, "%s", e400);
            fflush(f);
            fclose(f);
         }
      }


      else
      {
         close(socket_client);
      }
   }
   return 0;
}

/*
 * __________________________________________▓▓▓
 * _________________________________________▓▒▒▒▓▓
 * ____________________▄▄▄▄▄▄▄▄▄__________▓▒▒▒▒▒▓
 * ___▓▓▓▓▓____▄█████▓▓▓▓▓▓░░███████▓▒▒▒▒▓▒▓
 * ____▓▒▓▒▓▓▓██▓█▓▓▓▓▓▓▓░░░▓▓▓▓▓▓▓▓▒▒▒▒▒▓▒▓
 * ______▓▒▒▒▓▒▒▓▓▓▓▓▓▓▓░░░▓▓▓▓▓▓▓▓█▒▒▒▒▒▒▓▒▓
 * ______█▓▓▒▒▓▒▒▓▒▒▓▓▓░░░▓▓▓▓▓▓▓▓█▒▒▒▒▒▒▒▓▒▓
 * ____▄█▓▓█▓▓▓▒▒▒▓▒▓▓░░░░▓▓▓▓▓▓▓▓█▒▒▒▒▒▒▓▒▒▓
 * ___█▓▓▓█▓▓█▓▓▒▓▒▓▓▓░░░░▓▓▓▓▓▓▓▓▓█▒▒▒▒▓▒▒▒▓
 * __█▓▓▓█▓▓█▓▓▓▓▓▓▓▓▓░░░█████████████▒▒▒▒▒▒▓
 * __█▓▓▓█▓▓█▓▓▓▓▓▓██████▒▌__▓█_____▓▓▒▒▒▒▒▒▒▓
 * _▐█▓▓█▓▓▓█▓▓████▒▒▒▒▒▒▌__▓▓█▄____▓▓▒▒▒▒▒▒▓
 * _▐█▓█▓▓▓▓███▒▒▒▒▒▒▒▒▒▒▌__▓▓█████▓▓▒▒▒▒▒▒▓
 * __█▓█▓▓██_▅▄██▄▒▒▒▒▒▒▒▐___▓▓█▄_██▓▓▄▅▅▒▒▒▓
 * __█▓▓██__▅▄▄▄▌__▀▄▒▒▒▒▒▐___▓▓▓████▓▅▅▄▒▒▒█
 * __█▓█_________▓▄___▀▒▒▒▒▒▐____▓▓▓▓▓▓▅▅▄▒▒▒██
 * __██___________▓▓█▀█▄▒▒▒▒▒▌________▒▒▒▒▒▒█▓█▌
 * _________________▓▓███▒▒▒▒▒▐____▒▒▒██▒▒██▓██▌
 * ___________________▓▓▓▒▒▒▒▒▒▒▒▒▒▒▒█▓▓██▓▓██▓▌
 * ____________________▓▒▒▄▒▒▌▒▒▒▒▒▒▒█▓▓▓▓██▓▓▓█
 * ___________________▓▒▒▒▒▒▐▒▒▒▒▒▒▒█▓███▓▓▓█▓▓█▌
 * _____________________▓▓▓▄▀▒▒▒▒▓▓▓█▓▓▓▓▓▓█▓▓▓▓██
 * _________________________▓▓▓▓▓▓____█▓▓██▀▀█▓▓▓▓░░█
 * ______________________________________▀▀__▄█▓▓▓▓▓░░▓█
 * _______________________________________▄██▓▓▓▓▓▓░░▓▓█
 * _____________________________________██▓▓▓▓▓▓▓▓░░▓▓█
 * ______________________________________█▓▓▓▓▓▓▓░░░▓▓█
 * _______________________________________█▓▓▓▓▓░░░▓▓▓█
 * ________________________________________█▓▓▓░░░▓▓▓▓█
 * __________________________________________██░░░▓▓▓▓█
 * _____________________________________________█░▓▓▓█
 * _______________________________________________████
 */